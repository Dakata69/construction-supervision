# База данни - Детайлно обяснение

## Какво е база данни?

База данни е **структуриран начин за съхранение на данни**.

**Аналогия:** Като картотека с множество шкафове:
- Всеки **шкаф** = таблица (Projects, Documents, Users...)
- Всяко **чекмедже** = ред в таблицата (един конкретен проект)
- Всяка **папка в чекмеджето** = колона/поле (име, дата, статус...)

---

## Релационна база данни - Основи

Нашата система използва **релационна база данни** (SQLite в development, PostgreSQL в production).

### Какво означава "релационна"?

Таблиците са **свързани помежду си** с връзки (relations).

**Пример:**

```
┌─────────────────────┐         ┌─────────────────────┐
│   Project           │         │   Document          │
├─────────────────────┤         ├─────────────────────┤
│ id (PK)             │←────────│ id (PK)             │
│ name                │    1  * │ title               │
│ location            │         │ project_id (FK)     │
│ status              │         │ type                │
│ start_date          │         │ docx_file           │
└─────────────────────┘         └─────────────────────┘

Един проект има много документи
Project (1) ←──→ (*) Document
```

**Легенда:**
- **PK** = Primary Key (уникален идентификатор)
- **FK** = Foreign Key (връзка към друга таблица)
- **1** = Един (one)
- **\*** = Много (many)

---

## Структура на базата данни

### Схема на таблиците:

```
┌──────────────┐
│  auth_user   │ ← Django built-in
├──────────────┤
│ id           │
│ username     │
│ email        │
│ password     │
│ first_name   │
│ last_name    │
└──────┬───────┘
       │ 1
       │
       │ *
┌──────▼───────────────────────────────────────────┐
│  core_employee                                   │
├──────────────────────────────────────────────────┤
│ id                                               │
│ user_id (FK → auth_user.id)                     │
│ position                                         │
│ phone                                            │
│ is_admin                                         │
└──────────────────────────────────────────────────┘


┌─────────────────────┐
│  core_client        │
├─────────────────────┤
│ id                  │
│ name                │
│ email               │
│ phone               │
│ address             │
│ created_at          │
└─────────┬───────────┘
          │ 1
          │
          │ *
┌─────────▼─────────────────────────────────────────┐
│  core_project                                     │
├───────────────────────────────────────────────────┤
│ id                                                │
│ name                                              │
│ location                                          │
│ client_id (FK → core_client.id)                  │
│ start_date                                        │
│ end_date                                          │
│ status (active/completed/paused)                  │
│ progress (0-100)                                  │
│ description                                       │
│ created_at                                        │
│ updated_at                                        │
└─────────┬─────────────────────────────────────────┘
          │ 1
          │
          ├─────────────────┐
          │ *               │ *
┌─────────▼────────┐  ┌─────▼───────────────────────┐
│ core_document    │  │ core_act                    │
├──────────────────┤  ├─────────────────────────────┤
│ id               │  │ id                          │
│ title            │  │ act_number                  │
│ type             │  │ act_type (7/14/15)          │
│ project_id (FK)  │  │ project_id (FK)             │
│ docx_file        │  │ date                        │
│ pdf_file         │  │ status (draft/approved)     │
│ created_at       │  │ docx_file                   │
│ updated_at       │  │ pdf_file                    │
└──────────────────┘  │ data (JSON)                 │
                      │ created_at                  │
                      │ updated_at                  │
                      └─────────────────────────────┘


┌─────────────────────┐
│  core_task          │
├─────────────────────┤
│ id                  │
│ title               │
│ description         │
│ project_id (FK)     │
│ assigned_to_id (FK) │
│ status              │
│ priority            │
│ due_date            │
│ created_at          │
│ completed_at        │
└─────────────────────┘
```

---

## Таблици подробно

### 1. auth_user (Django built-in)

Django идва с вградена система за потребители.

```sql
CREATE TABLE auth_user (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    username VARCHAR(150) UNIQUE NOT NULL,
    email VARCHAR(254),
    password VARCHAR(128) NOT NULL,  -- Хеширана парола
    first_name VARCHAR(150),
    last_name VARCHAR(150),
    is_staff BOOLEAN DEFAULT 0,      -- Достъп до admin панел
    is_active BOOLEAN DEFAULT 1,
    is_superuser BOOLEAN DEFAULT 0,  -- Супер admin права
    date_joined DATETIME NOT NULL,
    last_login DATETIME
);
```

**Пример данни:**

| id | username | email | first_name | last_name | is_staff |
|----|----------|-------|------------|-----------|----------|
| 1 | admin | admin@example.com | Админ | Админов | 1 |
| 2 | ivan | ivan@example.com | Иван | Иванов | 1 |
| 3 | maria | maria@example.com | Мария | Петрова | 1 |

---

### 2. core_employee (Служители)

Разширява `auth_user` с допълнителна информация.

```sql
CREATE TABLE core_employee (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id INTEGER UNIQUE NOT NULL,  -- One-to-One с auth_user
    position VARCHAR(100),             -- Длъжност
    phone VARCHAR(20),
    is_admin BOOLEAN DEFAULT 0,        -- Администратор на системата
    
    FOREIGN KEY (user_id) REFERENCES auth_user(id) ON DELETE CASCADE
);
```

**Django модел:**

```python
from django.db import models
from django.contrib.auth.models import User

class Employee(models.Model):
    """Служител (разширява User модела)"""
    
    user = models.OneToOneField(
        User,
        on_delete=models.CASCADE,
        related_name='employee'
    )
    position = models.CharField(max_length=100, verbose_name='Длъжност')
    phone = models.CharField(max_length=20, blank=True)
    is_admin = models.BooleanField(default=False, verbose_name='Администратор')
    
    def __str__(self):
        return f"{self.user.get_full_name()} - {self.position}"
```

**Пример данни:**

| id | user_id | position | phone | is_admin |
|----|---------|----------|-------|----------|
| 1 | 1 | Главен инженер | 0888123456 | 1 |
| 2 | 2 | Строителен надзор | 0888234567 | 0 |
| 3 | 3 | Координатор проекти | 0888345678 | 0 |

**Как се използва:**

```python
# Взема User
user = User.objects.get(username='ivan')

# Достъп до Employee данни
employee = user.employee
print(employee.position)  # "Строителен надзор"
print(employee.is_admin)  # False

# Обратно - от Employee към User
employee = Employee.objects.get(id=2)
print(employee.user.first_name)  # "Иван"
```

---

### 3. core_client (Клиенти/Възложители)

```sql
CREATE TABLE core_client (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    name VARCHAR(200) NOT NULL,
    email VARCHAR(254),
    phone VARCHAR(20),
    address TEXT,
    created_at DATETIME NOT NULL,
    updated_at DATETIME NOT NULL
);
```

**Django модел:**

```python
class Client(models.Model):
    """Клиент/Възложител на проект"""
    
    name = models.CharField(max_length=200, verbose_name='Име')
    email = models.EmailField(blank=True)
    phone = models.CharField(max_length=20, blank=True)
    address = models.TextField(blank=True, verbose_name='Адрес')
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    
    class Meta:
        verbose_name = 'Клиент'
        verbose_name_plural = 'Клиенти'
    
    def __str__(self):
        return self.name
```

**Пример данни:**

| id | name | email | phone | address | created_at |
|----|------|-------|-------|---------|------------|
| 1 | Строй ЕООД | office@stroy.bg | 02123456 | София, бул. България 1 | 2025-01-10 10:00:00 |
| 2 | Билд БГ ООД | info@build.bg | 02234567 | Пловдив, ул. Марица 5 | 2025-02-15 14:30:00 |

---

### 4. core_project (Проекти)

Централната таблица - всичко се върти около проектите.

```sql
CREATE TABLE core_project (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    name VARCHAR(200) NOT NULL,
    location TEXT NOT NULL,
    client_id INTEGER NOT NULL,       -- FK към core_client
    start_date DATE,
    end_date DATE,
    status VARCHAR(20) DEFAULT 'active',  -- active/completed/paused
    progress INTEGER DEFAULT 0,       -- 0-100 процента
    description TEXT,
    created_at DATETIME NOT NULL,
    updated_at DATETIME NOT NULL,
    
    FOREIGN KEY (client_id) REFERENCES core_client(id) ON DELETE CASCADE
);

-- Индекс за по-бързо търсене по статус
CREATE INDEX idx_project_status ON core_project(status);

-- Индекс за по-бързо търсене по client
CREATE INDEX idx_project_client ON core_project(client_id);
```

**Django модел:**

```python
class Project(models.Model):
    STATUS_CHOICES = [
        ('active', 'Активен'),
        ('completed', 'Завършен'),
        ('paused', 'Спрян'),
    ]
    
    name = models.CharField(max_length=200, verbose_name='Име на проект')
    location = models.TextField(verbose_name='Местонахождение')
    client = models.ForeignKey(
        Client,
        on_delete=models.CASCADE,
        related_name='projects',
        verbose_name='Клиент'
    )
    start_date = models.DateField(null=True, blank=True, verbose_name='Начална дата')
    end_date = models.DateField(null=True, blank=True, verbose_name='Крайна дата')
    status = models.CharField(
        max_length=20,
        choices=STATUS_CHOICES,
        default='active',
        verbose_name='Статус'
    )
    progress = models.IntegerField(default=0, verbose_name='Прогрес %')
    description = models.TextField(blank=True, verbose_name='Описание')
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    
    class Meta:
        ordering = ['-created_at']
        verbose_name = 'Проект'
        verbose_name_plural = 'Проекти'
    
    def __str__(self):
        return self.name
```

**Пример данни:**

| id | name | location | client_id | start_date | end_date | status | progress | created_at |
|----|------|----------|-----------|------------|----------|--------|----------|------------|
| 1 | Жилищна сграда | гр. София, ул. Витоша 1 | 1 | 2025-01-15 | 2026-06-30 | active | 75 | 2025-01-10 |
| 2 | Офис комплекс | гр. Пловдив, бул. Марица 10 | 2 | 2025-03-01 | 2026-12-31 | active | 30 | 2025-02-20 |
| 3 | Търговски център | гр. Варна, ул. Приморска 5 | 1 | 2024-06-01 | 2025-05-31 | completed | 100 | 2024-05-15 |

---

### 5. core_document (Документи)

Генерирани документи (актове, протоколи, удостоверения...).

```sql
CREATE TABLE core_document (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    title VARCHAR(200) NOT NULL,
    type VARCHAR(50) NOT NULL,        -- act14, act7, protocol, certificate...
    project_id INTEGER NOT NULL,
    docx_file VARCHAR(255),           -- Път до .docx файл
    pdf_file VARCHAR(255),            -- Път до .pdf файл
    created_at DATETIME NOT NULL,
    updated_at DATETIME NOT NULL,
    
    FOREIGN KEY (project_id) REFERENCES core_project(id) ON DELETE CASCADE
);

CREATE INDEX idx_document_project ON core_document(project_id);
CREATE INDEX idx_document_type ON core_document(type);
```

**Django модел:**

```python
class Document(models.Model):
    title = models.CharField(max_length=200, verbose_name='Заглавие')
    type = models.CharField(max_length=50, verbose_name='Тип')
    project = models.ForeignKey(
        Project,
        on_delete=models.CASCADE,
        related_name='documents',
        verbose_name='Проект'
    )
    docx_file = models.FileField(
        upload_to='documents/%Y/%m/',
        blank=True,
        verbose_name='Word файл'
    )
    pdf_file = models.FileField(
        upload_to='documents/%Y/%m/',
        blank=True,
        verbose_name='PDF файл'
    )
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    
    class Meta:
        ordering = ['-created_at']
        verbose_name = 'Документ'
        verbose_name_plural = 'Документи'
    
    def __str__(self):
        return f"{self.title} ({self.type})"
```

**Пример данни:**

| id | title | type | project_id | docx_file | pdf_file | created_at |
|----|-------|------|------------|-----------|----------|------------|
| 1 | Акт 14 за приемане | act14 | 1 | generated/act14_20251128_150000.docx | generated/act14_20251128_150000.pdf | 2025-11-28 15:00:00 |
| 2 | Акт 7 за скрити работи | act7 | 1 | generated/act7_20251125_140000.docx | generated/act7_20251125_140000.pdf | 2025-11-25 14:00:00 |
| 3 | Протокол от среща | protocol | 2 | generated/protocol_20251120_100000.docx | generated/protocol_20251120_100000.pdf | 2025-11-20 10:00:00 |

---

### 6. core_act (Актове)

Специализирана таблица за актове (Акт 7, 14, 15).

```sql
CREATE TABLE core_act (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    act_number VARCHAR(50) UNIQUE NOT NULL,  -- Уникален номер
    act_type VARCHAR(10) NOT NULL,           -- 7, 14, 15
    project_id INTEGER NOT NULL,
    date DATE NOT NULL,
    status VARCHAR(20) DEFAULT 'draft',      -- draft/approved
    docx_file VARCHAR(255),
    pdf_file VARCHAR(255),
    data JSON,                               -- Динамични данни (JSON)
    created_at DATETIME NOT NULL,
    updated_at DATETIME NOT NULL,
    
    FOREIGN KEY (project_id) REFERENCES core_project(id) ON DELETE CASCADE
);

CREATE INDEX idx_act_project ON core_act(project_id);
CREATE INDEX idx_act_type ON core_act(act_type);
CREATE UNIQUE INDEX idx_act_number ON core_act(act_number);
```

**Django модел:**

```python
class Act(models.Model):
    ACT_TYPE_CHOICES = [
        ('7', 'Акт 7 - Скрити работи'),
        ('14', 'Акт 14 - Установяване годност'),
        ('15', 'Акт 15 - Приемане на строеж'),
    ]
    
    STATUS_CHOICES = [
        ('draft', 'Чернова'),
        ('approved', 'Одобрен'),
    ]
    
    act_number = models.CharField(
        max_length=50,
        unique=True,
        verbose_name='Номер на акт'
    )
    act_type = models.CharField(
        max_length=10,
        choices=ACT_TYPE_CHOICES,
        verbose_name='Тип акт'
    )
    project = models.ForeignKey(
        Project,
        on_delete=models.CASCADE,
        related_name='acts',
        verbose_name='Проект'
    )
    date = models.DateField(verbose_name='Дата')
    status = models.CharField(
        max_length=20,
        choices=STATUS_CHOICES,
        default='draft',
        verbose_name='Статус'
    )
    docx_file = models.FileField(upload_to='acts/%Y/', blank=True)
    pdf_file = models.FileField(upload_to='acts/%Y/', blank=True)
    data = models.JSONField(default=dict, verbose_name='Данни')
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    
    class Meta:
        ordering = ['-date']
        verbose_name = 'Акт'
        verbose_name_plural = 'Актове'
    
    def __str__(self):
        return f"Акт {self.act_type} - {self.act_number}"
```

**Пример данни:**

| id | act_number | act_type | project_id | date | status | data (JSON) |
|----|------------|----------|------------|------|--------|-------------|
| 1 | 14-2025-001 | 14 | 1 | 2025-11-28 | approved | `{"client_name": "Строй ЕООД", ...}` |
| 2 | 7-2025-015 | 7 | 1 | 2025-11-25 | draft | `{"floor": "Партер", "work_type": "Бетониране"}` |
| 3 | 15-2025-003 | 15 | 3 | 2025-05-30 | approved | `{"final_inspection": true, ...}` |

**JSON data пример:**

```json
{
  "client_name": "Строй ЕООД",
  "consultant_name": "Инж. Иван Иванов",
  "designer_name": "Арх. Петър Петров",
  "contractor_name": "Билдинг ООД",
  "location": "гр. София, ул. Витоша 1",
  "description": "Изпълнени всички изисквания",
  "notes": "Без забележки"
}
```

---

### 7. core_task (Задачи)

Задачи в проекта, assigned към служители.

```sql
CREATE TABLE core_task (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    title VARCHAR(200) NOT NULL,
    description TEXT,
    project_id INTEGER NOT NULL,
    assigned_to_id INTEGER,              -- FK към core_employee
    status VARCHAR(20) DEFAULT 'todo',   -- todo/in_progress/done
    priority VARCHAR(20) DEFAULT 'medium', -- low/medium/high
    due_date DATE,
    created_at DATETIME NOT NULL,
    completed_at DATETIME,
    
    FOREIGN KEY (project_id) REFERENCES core_project(id) ON DELETE CASCADE,
    FOREIGN KEY (assigned_to_id) REFERENCES core_employee(id) ON DELETE SET NULL
);

CREATE INDEX idx_task_project ON core_task(project_id);
CREATE INDEX idx_task_assigned ON core_task(assigned_to_id);
CREATE INDEX idx_task_status ON core_task(status);
```

**Django модел:**

```python
class Task(models.Model):
    STATUS_CHOICES = [
        ('todo', 'За изпълнение'),
        ('in_progress', 'В процес'),
        ('done', 'Завършена'),
    ]
    
    PRIORITY_CHOICES = [
        ('low', 'Нисък'),
        ('medium', 'Среден'),
        ('high', 'Висок'),
    ]
    
    title = models.CharField(max_length=200, verbose_name='Заглавие')
    description = models.TextField(blank=True, verbose_name='Описание')
    project = models.ForeignKey(
        Project,
        on_delete=models.CASCADE,
        related_name='tasks',
        verbose_name='Проект'
    )
    assigned_to = models.ForeignKey(
        Employee,
        on_delete=models.SET_NULL,
        null=True,
        blank=True,
        related_name='tasks',
        verbose_name='Отговорен'
    )
    status = models.CharField(
        max_length=20,
        choices=STATUS_CHOICES,
        default='todo',
        verbose_name='Статус'
    )
    priority = models.CharField(
        max_length=20,
        choices=PRIORITY_CHOICES,
        default='medium',
        verbose_name='Приоритет'
    )
    due_date = models.DateField(null=True, blank=True, verbose_name='Краен срок')
    created_at = models.DateTimeField(auto_now_add=True)
    completed_at = models.DateTimeField(null=True, blank=True)
    
    class Meta:
        ordering = ['due_date', '-priority']
        verbose_name = 'Задача'
        verbose_name_plural = 'Задачи'
    
    def __str__(self):
        return self.title
```

---

## Връзки между таблици (Relationships)

### One-to-One (1:1)

Един User има точно един Employee профил.

```python
# User → Employee
user = User.objects.get(id=1)
employee = user.employee

# Employee → User
employee = Employee.objects.get(id=1)
user = employee.user
```

### One-to-Many (1:N)

Един Client има много Projects.

```python
# Client → Projects
client = Client.objects.get(id=1)
projects = client.projects.all()  # related_name='projects'

# Project → Client
project = Project.objects.get(id=1)
client = project.client
```

### Many-to-Many (M:N)

(Не се използва в текущата схема, но за бъдеще...)

Пример: Един проект може да има много служители, и всеки служител работи по много проекти.

```python
class ProjectMember(models.Model):
    """Join таблица"""
    project = models.ForeignKey(Project, on_delete=models.CASCADE)
    employee = models.ForeignKey(Employee, on_delete=models.CASCADE)
    role = models.CharField(max_length=50)  # "Manager", "Supervisor"...
    joined_at = models.DateTimeField(auto_now_add=True)
    
    class Meta:
        unique_together = ['project', 'employee']

# Използване
project = Project.objects.get(id=1)
members = project.projectmember_set.all()

for member in members:
    print(f"{member.employee.user.get_full_name()} - {member.role}")
```

---

## Django ORM - Queries (Заявки)

ORM = Object-Relational Mapping - превежда Python код в SQL.

### Основни операции:

```python
# ══════════════════════════════════════════════════════════
# 1. Вземане на всички записи (SELECT *)
# ══════════════════════════════════════════════════════════
projects = Project.objects.all()
# SQL: SELECT * FROM core_project;

# ══════════════════════════════════════════════════════════
# 2. Филтриране (WHERE)
# ══════════════════════════════════════════════════════════
active_projects = Project.objects.filter(status='active')
# SQL: SELECT * FROM core_project WHERE status = 'active';

# Множество условия (AND)
projects = Project.objects.filter(status='active', progress__gte=50)
# SQL: SELECT * FROM core_project WHERE status = 'active' AND progress >= 50;

# OR условия
from django.db.models import Q
projects = Project.objects.filter(Q(status='active') | Q(progress=100))
# SQL: SELECT * FROM core_project WHERE status = 'active' OR progress = 100;

# ══════════════════════════════════════════════════════════
# 3. Вземане на един запис
# ══════════════════════════════════════════════════════════
project = Project.objects.get(id=1)
# SQL: SELECT * FROM core_project WHERE id = 1 LIMIT 1;

# Или с filter().first()
project = Project.objects.filter(name='Жилищна сграда').first()

# ══════════════════════════════════════════════════════════
# 4. Създаване на нов запис (INSERT)
# ══════════════════════════════════════════════════════════
client = Client.objects.get(id=1)
project = Project.objects.create(
    name='Нов проект',
    location='София',
    client=client,
    status='active',
    progress=0
)
# SQL: INSERT INTO core_project (name, location, client_id, ...) VALUES (...);

# ══════════════════════════════════════════════════════════
# 5. Обновяване (UPDATE)
# ══════════════════════════════════════════════════════════
project = Project.objects.get(id=1)
project.progress = 85
project.save()
# SQL: UPDATE core_project SET progress = 85 WHERE id = 1;

# Bulk update
Project.objects.filter(status='paused').update(status='active')
# SQL: UPDATE core_project SET status = 'active' WHERE status = 'paused';

# ══════════════════════════════════════════════════════════
# 6. Изтриване (DELETE)
# ══════════════════════════════════════════════════════════
project = Project.objects.get(id=5)
project.delete()
# SQL: DELETE FROM core_project WHERE id = 5;

# Bulk delete
Project.objects.filter(status='cancelled').delete()

# ══════════════════════════════════════════════════════════
# 7. Подреждане (ORDER BY)
# ══════════════════════════════════════════════════════════
projects = Project.objects.all().order_by('-created_at')  # DESC
# SQL: SELECT * FROM core_project ORDER BY created_at DESC;

projects = Project.objects.all().order_by('name')  # ASC
# SQL: SELECT * FROM core_project ORDER BY name ASC;

# ══════════════════════════════════════════════════════════
# 8. Лимит (LIMIT / OFFSET)
# ══════════════════════════════════════════════════════════
projects = Project.objects.all()[:10]  # Първите 10
# SQL: SELECT * FROM core_project LIMIT 10;

projects = Project.objects.all()[10:20]  # Записи 10-20
# SQL: SELECT * FROM core_project LIMIT 10 OFFSET 10;

# ══════════════════════════════════════════════════════════
# 9. Counts (COUNT)
# ══════════════════════════════════════════════════════════
count = Project.objects.filter(status='active').count()
# SQL: SELECT COUNT(*) FROM core_project WHERE status = 'active';

# ══════════════════════════════════════════════════════════
# 10. Exists (проверка дали съществува)
# ══════════════════════════════════════════════════════════
exists = Project.objects.filter(name='Test').exists()
# SQL: SELECT 1 FROM core_project WHERE name = 'Test' LIMIT 1;
```

---

## Advanced Queries

### 1. Joins (Свързване на таблици)

```python
# ══════════════════════════════════════════════════════════
# select_related (за ForeignKey, OneToOne)
# ══════════════════════════════════════════════════════════
# Проблем: N+1 queries
projects = Project.objects.all()
for project in projects:
    print(project.client.name)  # Всеки път прави нова SQL заявка!

# Решение: select_related
projects = Project.objects.select_related('client').all()
for project in projects:
    print(project.client.name)  # Само 1 SQL заявка (JOIN)

# SQL: 
# SELECT * FROM core_project 
# LEFT JOIN core_client ON core_project.client_id = core_client.id;


# ══════════════════════════════════════════════════════════
# prefetch_related (за ManyToMany, reverse ForeignKey)
# ══════════════════════════════════════════════════════════
# Проблем: N+1
clients = Client.objects.all()
for client in clients:
    print(client.projects.count())  # N SQL заявки

# Решение: prefetch_related
clients = Client.objects.prefetch_related('projects').all()
for client in clients:
    print(client.projects.count())  # 2 SQL заявки (1 за clients, 1 за projects)

# SQL:
# 1. SELECT * FROM core_client;
# 2. SELECT * FROM core_project WHERE client_id IN (1, 2, 3, ...);
```

### 2. Aggregations (Агрегации)

```python
from django.db.models import Count, Sum, Avg, Max, Min

# ══════════════════════════════════════════════════════════
# Count (брой)
# ══════════════════════════════════════════════════════════
project_count = Project.objects.count()

# Брой проекти по клиент
clients = Client.objects.annotate(project_count=Count('projects'))
for client in clients:
    print(f"{client.name}: {client.project_count} проекта")

# ══════════════════════════════════════════════════════════
# Avg (средна стойност)
# ══════════════════════════════════════════════════════════
from django.db.models import Avg
avg_progress = Project.objects.aggregate(Avg('progress'))
print(avg_progress)  # {'progress__avg': 62.5}

# ══════════════════════════════════════════════════════════
# Sum (сума)
# ══════════════════════════════════════════════════════════
total_projects = Client.objects.aggregate(total=Count('projects'))

# ══════════════════════════════════════════════════════════
# Max/Min
# ══════════════════════════════════════════════════════════
latest_project = Project.objects.aggregate(Max('created_at'))
```

### 3. Lookup expressions (Операции)

```python
# ══════════════════════════════════════════════════════════
# __exact (точно съвпадение) - по подразбиране
# ══════════════════════════════════════════════════════════
Project.objects.filter(status__exact='active')
# Същото като:
Project.objects.filter(status='active')

# ══════════════════════════════════════════════════════════
# __iexact (case-insensitive)
# ══════════════════════════════════════════════════════════
Project.objects.filter(name__iexact='ЖИЛИЩНА СГРАДА')
# Намира "жилищна сграда", "ЖИЛИЩНА СГРАДА", "Жилищна Сграда"

# ══════════════════════════════════════════════════════════
# __contains (съдържа)
# ══════════════════════════════════════════════════════════
Project.objects.filter(name__contains='сграда')
# SQL: WHERE name LIKE '%сграда%'

# __icontains (case-insensitive)
Project.objects.filter(name__icontains='СГРАДА')

# ══════════════════════════════════════════════════════════
# __startswith / __endswith
# ══════════════════════════════════════════════════════════
Project.objects.filter(name__startswith='Жилищна')
Project.objects.filter(name__endswith='сграда')

# ══════════════════════════════════════════════════════════
# __gt, __gte, __lt, __lte (>, >=, <, <=)
# ══════════════════════════════════════════════════════════
Project.objects.filter(progress__gt=50)      # progress > 50
Project.objects.filter(progress__gte=50)     # progress >= 50
Project.objects.filter(progress__lt=50)      # progress < 50
Project.objects.filter(progress__lte=50)     # progress <= 50

# ══════════════════════════════════════════════════════════
# __in (IN списък)
# ══════════════════════════════════════════════════════════
Project.objects.filter(status__in=['active', 'completed'])
# SQL: WHERE status IN ('active', 'completed')

# ══════════════════════════════════════════════════════════
# __range (BETWEEN)
# ══════════════════════════════════════════════════════════
from datetime import date
Project.objects.filter(start_date__range=[date(2025, 1, 1), date(2025, 12, 31)])
# SQL: WHERE start_date BETWEEN '2025-01-01' AND '2025-12-31'

# ══════════════════════════════════════════════════════════
# __isnull (NULL проверка)
# ══════════════════════════════════════════════════════════
Project.objects.filter(end_date__isnull=True)   # end_date IS NULL
Project.objects.filter(end_date__isnull=False)  # end_date IS NOT NULL

# ══════════════════════════════════════════════════════════
# Дата операции
# ══════════════════════════════════════════════════════════
# Проекти създадени тази година
Project.objects.filter(created_at__year=2025)

# Проекти създадени през януари
Project.objects.filter(created_at__month=1)

# Проекти създадени днес
from datetime import date
Project.objects.filter(created_at__date=date.today())
```

---

## Migrations (Миграции)

Миграциите са "история" на промените в базата данни.

### Какво е migration файл?

```python
# backend/core/migrations/0001_initial.py
from django.db import migrations, models

class Migration(migrations.Migration):
    initial = True
    
    dependencies = []
    
    operations = [
        migrations.CreateModel(
            name='Client',
            fields=[
                ('id', models.BigAutoField(primary_key=True)),
                ('name', models.CharField(max_length=200)),
                ('email', models.EmailField()),
                ('created_at', models.DateTimeField(auto_now_add=True)),
            ],
        ),
    ]
```

**SQL което се генерира:**

```sql
CREATE TABLE core_client (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    name VARCHAR(200) NOT NULL,
    email VARCHAR(254) NOT NULL,
    created_at DATETIME NOT NULL
);
```

### Команди:

```bash
# 1. Създава migration файлове (след промяна в models.py)
python manage.py makemigrations

# 2. Прилага migrations към базата данни
python manage.py migrate

# 3. Показва SQL код на migration
python manage.py sqlmigrate core 0001

# 4. Показва статус на всички migrations
python manage.py showmigrations
```

### Workflow:

```
1. Променяш models.py
   (напр. добавяш поле `priority` в Task модел)

2. python manage.py makemigrations
   → Създава 0008_task_priority.py

3. python manage.py migrate
   → Изпълнява SQL:
     ALTER TABLE core_task ADD COLUMN priority VARCHAR(20) DEFAULT 'medium';

4. Базата данни е обновена!
```

---

## Raw SQL Queries

Понякога ORM не е достатъчен - трябва директен SQL.

```python
from django.db import connection

def get_project_stats():
    """Статистики с RAW SQL"""
    
    with connection.cursor() as cursor:
        cursor.execute("""
            SELECT 
                c.name AS client_name,
                COUNT(p.id) AS project_count,
                AVG(p.progress) AS avg_progress
            FROM core_client c
            LEFT JOIN core_project p ON c.id = p.client_id
            GROUP BY c.id, c.name
            ORDER BY project_count DESC
        """)
        
        results = cursor.fetchall()
        
        # Преобразува към dict
        stats = []
        for row in results:
            stats.append({
                'client_name': row[0],
                'project_count': row[1],
                'avg_progress': row[2],
            })
        
        return stats

# Използване
stats = get_project_stats()
for stat in stats:
    print(f"{stat['client_name']}: {stat['project_count']} проекта, средно {stat['avg_progress']:.1f}%")
```

---

## Database optimization (Оптимизация)

### 1. Indexes (Индекси)

Индексите правят търсенето много по-бързо.

```python
class Project(models.Model):
    name = models.CharField(max_length=200)
    status = models.CharField(max_length=20, db_index=True)  # Индекс!
    
    class Meta:
        indexes = [
            models.Index(fields=['status', 'created_at']),  # Composite index
        ]
```

**Когато да използваш индекс:**
- Полета, по които често филтрираш (`status`, `client_id`)
- Полета, по които често order_by (`created_at`)
- ForeignKey полета (Django автоматично създава индекси)

**Когато ДА НЕ използваш индекс:**
- Полета, които почти никога не се търсят
- Много големи текстови полета (description)

### 2. N+1 Problem

**Проблем:**

```python
# Лошо - N+1 queries
projects = Project.objects.all()  # 1 query
for project in projects:  # N queries (по един за всеки проект)
    print(project.client.name)

# Ако има 100 проекта → 101 SQL заявки!
```

**Решение:**

```python
# Добре - само 1 query (JOIN)
projects = Project.objects.select_related('client').all()
for project in projects:
    print(project.client.name)
```

### 3. Pagination

Не зареждай всички записи наведнъж!

```python
from django.core.paginator import Paginator

def get_projects_page(page_number=1, page_size=20):
    projects = Project.objects.all().order_by('-created_at')
    paginator = Paginator(projects, page_size)
    page = paginator.get_page(page_number)
    return page

# API endpoint
def list_projects(request):
    page_number = request.GET.get('page', 1)
    page = get_projects_page(page_number)
    
    return {
        'results': [...],  # Проекти на тази страница
        'total': page.paginator.count,
        'page': page.number,
        'pages': page.paginator.num_pages,
    }
```

---

## Следваща стъпка

Това е краят на основната документация!

**Допълнителни ресурси:**
- Django документация: https://docs.djangoproject.com/
- Django REST Framework: https://www.django-rest-framework.org/
- React документация: https://react.dev/
- Ant Design: https://ant.design/

**За въпроси и помощ:**
- Вижте API.md за пълен API reference
- Вижте MANUAL.md за user manual
